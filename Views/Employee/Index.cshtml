@model IEnumerable<EmployeeApp.Models.Employee>

@{ ViewBag.Title = "Employee List"; }
@{
    bool isAdmin = Session["Role"] != null && Session["Role"].ToString() == "Admin";
}

<div class="container mt-4">
    <h2>Employee List</h2>
    @if (isAdmin)
    {
        <div class="row mb-3">
            <div class="col-md-4">
                @Html.ActionLink("Create New", "Create", null, new { @class = "btn btn-primary w-50" })
            </div>
        </div>
    }
    <form id="printForm" action="@Url.Action("Print", "Employee")" method="GET" target="_blank">

        <input type="hidden" id="targetEmpId" name="id" value="0" />

        <div class="row mb-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Company Name</label>
                <input type="text" name="companyName" class="form-control" placeholder="Enter Name" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Address</label>
                <input type="text" name="companyAddr" class="form-control" placeholder="Enter Address" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Mobile</label>
                <input type="text" name="companyMobile" class="form-control" placeholder="Enter Mobile" />
            </div>

            <div class="col-md-3">
                <button type="button" onclick="printEmployee(0)" class="btn btn-dark w-100">Print All</button>
            </div>
        </div>
    </form>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">Search & Filter</h5>
        </div>
        <div class="card-body bg-light">
            @using (Html.BeginForm("Index", "Employee", FormMethod.Get, new { id = "searchForm" }))
            {
                <div class="row align-items-end">

                    <div class="col-md-3">
                        <label class="form-label fw-bold">Name / Father's Name</label>
                        @Html.TextBox("searchName", Request.QueryString["searchName"], new { @class = "form-control", placeholder = "Enter Name..." })
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-bold">Department</label>
                        @Html.DropDownList("searchDept", ViewBag.DeptList as SelectList, "-- All Departments --", new { @class = "form-control" })
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-bold">Mobile Number</label>
                        @Html.TextBox("searchMobile", Request.QueryString["searchMobile"], new { @class = "form-control", placeholder = "Enter Mobile..." })
                    </div>

                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100 mb-2">
                            🔍 Search
                        </button>
                        <a href="@Url.Action("Index")" class="btn btn-outline-secondary w-100">
                            Clear Filters
                        </a>
                    </div>
                </div>
            }
        </div>
    </div>


    <table class="table table-bordered table-hover align-middle text-center">
        <thead class="thead-light">
            <tr>
                <th style="white-space: nowrap;">Sr. No.</th>
                <th style="white-space: nowrap;">Name</th>
                <th style="white-space: nowrap;">Father's Name</th>
                <th style="white-space: nowrap;">Gender</th>
                <th style="white-space: nowrap;">DOB</th>
                <th style="white-space: nowrap;">Address</th>
                <th style="white-space: nowrap;">Dept</th>
                <th style="white-space: nowrap;">Mobile</th>
                <th style="white-space: nowrap;">Email</th>
                <th style="white-space: nowrap;">Aadhaar</th>
                <th style="white-space: nowrap;">Joining Date</th>
                <th style="white-space: nowrap;"></th>
            </tr>
        </thead>
        <tbody>
            @{
                int Serial = 1;
            }

            @foreach (var item in Model)
            {
                <tr class="text-center">
                    <td>@Serial</td>
                    <td>@Html.DisplayFor(m => item.Name)</td>
                    <td>@Html.DisplayFor(m => item.fatherName)</td>
                    <td>@Html.DisplayFor(m => item.Gender)</td>
                    <td style="white-space: nowrap;">
                        @(item.DOB.HasValue ? item.DOB.Value.ToString("dd-MM-yyyy") : "")
                    </td>
                    <td style="max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="@item.Address">
                        @Html.DisplayFor(m => item.Address)
                    </td>
                    <td>@(item.DeptMaster != null ? item.DeptMaster.DeptName : "-")</td>
                    <td>@Html.DisplayFor(m => item.Mobile)</td>
                    <td>@Html.DisplayFor(m => item.Email)</td>
                    <td>@Html.DisplayFor(m => item.Aadhaar)</td>
                    <td style="white-space: nowrap;">
                        @(item.JoiningDate.HasValue ? item.JoiningDate.Value.ToString("dd-MM-yyyy") : "")
                    </td>
                    <td class="d-grid gap-2 d-md-flex justify-content-md-center">
                        @if (isAdmin)
                        {
                            @Html.ActionLink("Edit", "Edit", new { id = item.EmpId }, new { @class = "btn btn-warning" })
                            @Html.ActionLink("Delete", "Delete", new { id = item.EmpId }, new { @class = "btn btn-danger", onclick = "return confirm('Are you sure you want to delete this employee?');" })
                        }
                        <button type="button" class="btn btn-info" onclick="printEmployee(@item.EmpId)">Print</button>
                    </td>
                </tr>

                {
                    Serial++;
                }
            }
        </tbody>
    </table>
</div>

<script>
    function printEmployee(empId) {
        // 1. Find the hidden input by ID and set it to the specific Employee ID
        var hiddenInput = document.getElementById('targetEmpId');
        if (hiddenInput) {
            hiddenInput.value = empId;
        } else {
            alert("Error: Could not find hidden input 'targetEmpId'");
            return;
        }

        // 2. Submit the form (This sends the ID + Company Details you typed)
        var form = document.getElementById('printForm');
        if (form) {
            form.submit();
        } else {
            alert("Error: Could not find form 'printForm'");
        }
    }
</script>
