@model EmployeeApp.Models.Employee

@{
    // Determine Mode
    bool isEdit = Model != null && Model.EmpId > 0;
    ViewBag.Title = isEdit ? "Edit Employee" : "Register Employee";
}

<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
    /* 1. Photo Card Container */
    .photo-card {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        background-color: #fff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        /* Center content inside the card */
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* 2. Header Text */
    .photo-header {
        text-align: center;
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 16px;
        color: #333;
        width: 100%;
    }

    body.dark-mode .photo-header {
        color: #fff;
    }

    /* 3. Photo Placeholder - FIXED WIDTH */
    .photo-placeholder {
        background-color: #e9ecef;
        width: 100%; /* Take full available width */
        max-width: 250px; /* ...but don't get wider than 250px */
        height: 250px; /* <--- FIXED HEIGHT (Square) */
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 10px;
        overflow: hidden;
        border-radius: 3px;
        border: 1px solid #dee2e6;
    }

        .photo-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Ensures image fits inside without stretching */
        }

    /* 4. Form Labels & Controls */
    .form-label {
        font-weight: 500;
        margin-bottom: 5px;
        display: block;
    }

    .form-control {
        border-radius: 4px;
        border: 1px solid #ced4da;
    }

    /* --- 5. FILE INPUT GROUP (The Gap Fix) --- */
    .file-input-group {
        display: flex;
        width: 100%;
        border: 1px solid #ced4da;
        border-radius: 4px;
        overflow: hidden;
        background-color: #fff;
        padding: 0;
        /* Ensure it matches the fixed width of the placeholder if desired,
           or leave 100% to fill the card width */
        max-width: 250px; /* Match placeholder width for neatness */
    }

    body.dark-mode .file-input-group {
        border-color: #444;
        background-color: #2d2d2d;
    }

    /* THE INPUT: Force it to behave */
    .file-input-group .form-control {
        flex-grow: 1 !important; /* Grow to fill space */
        width: 0 !important; /* Force width to 0 so flex-grow takes over */
        min-width: 0 !important; /* Allow shrinking below content size if needed */
        border: none !important;
        outline: none !important;
        box-shadow: none !important;
        margin: 0 !important;
        background-color: transparent;
        color: inherit;
        border-radius: 0 !important;
        height: auto; /* Let it define its own height */
    }

    /* THE BUTTON: Stuck to the right */
    .file-input-group .btn {
        flex: 0 0 auto;
        border: none !important;
        border-radius: 0 !important;
        margin: 0 !important;
        border-left: 1px solid #ced4da !important;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 15px;
        background-color: #dc3545; /* Red */
        color: white;
    }

    body.dark-mode .file-input-group .btn {
        border-left: 1px solid #555 !important;
    }
</style>

<div class="container mt-4">
    <h2 class="mb-4">@(isEdit ? "Edit Employee" : "Register Employee")</h2>

    @using (Html.BeginForm(isEdit ? "Edit" : "Create", "Employee", FormMethod.Post, new { enctype = "multipart/form-data", id = "empForm", onsubmit = "return validateForm()" }))
    {
        @Html.AntiForgeryToken()

        @Html.HiddenFor(m => m.EmpId)
        @Html.HiddenFor(m => m.ImagePath)

        <div class="row">
        <div class="col-md-8">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Employee Name</label>
                    @Html.EditorFor(m => m.Name, new { htmlAttributes = new { @class = "form-control", id = "txtName" } })
                </div>
                <div class="col-md-6">
                    <label class="form-label">Gender</label>
                    <div class="pt-2">
                        <div class="form-check form-check-inline">
                            @Html.RadioButtonFor(m => m.Gender, "Male", new { @class = "form-check-input", id = "genderMale", @checked = "checked" })
                            <label class="form-check-label" for="genderMale">Male</label>
                        </div>
                        <div class="form-check form-check-inline">
                            @Html.RadioButtonFor(m => m.Gender, "Female", new { @class = "form-check-input", id = "genderFemale" })
                            <label class="form-check-label" for="genderFemale">Female</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Date of Birth</label>
                    @Html.TextBoxFor(m => m.DOB, "{0:yyyy-MM-dd}", new { @class = "form-control", id = "txtDOB", autocomplete = "off", placeholder = "dd-mm-yyyy" })
                </div>
                <div class="col-md-6">
                    <label class="form-label">Father's Name</label>
                    @Html.EditorFor(m => m.fatherName, new { htmlAttributes = new { @class = "form-control", id = "txtFather" } })
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Mobile Number</label>
                    @Html.EditorFor(m => m.Mobile, new { htmlAttributes = new { @class = "form-control", id = "txtMobile" } })
                </div>
                <div class="col-md-6">
                    <label class="form-label">Email ID</label>
                    @Html.EditorFor(m => m.Email, new { htmlAttributes = new { @class = "form-control", id = "txtEmail" } })
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Address</label>
                    @Html.TextAreaFor(m => m.Address, new { @class = "form-control", rows = 2, id = "txtAddress" })
                </div>
                <div class="col-md-6">
                    <label class="form-label">Joining Date</label>
                    @Html.TextBoxFor(m => m.JoiningDate, "{0:yyyy-MM-dd}", new { @class = "form-control", id = "txtJoin", autocomplete = "off", placeholder = "dd-mm-yyyy" })
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Department</label>
                    @Html.DropDownListFor(m => m.DeptID, ViewBag.DeptList as SelectList, "-- Select Department --", new { @class = "form-control", id = "ddlDept" })
                    @Html.ValidationMessageFor(m => m.DeptID, "", new { @class = "text-danger" })
                </div>
                <div class="col-md-6">
                    <label class="form-label">Aadhaar Number</label>
                    @Html.EditorFor(m => m.Aadhaar, new { htmlAttributes = new { @class = "form-control", id = "txtAadhaar" } })
                </div>
            </div>

            <div class="mt-4">
                <input type="submit" value="@(isEdit ? "Update" : "Save")" class="btn @(isEdit ? "btn-warning" : "btn-primary") px-5" />

                @if (isEdit)
                {
                    @Html.ActionLink("Cancel", "Index", null, new { @class = "btn btn-secondary ms-2" })
                }
            </div>
        </div>

        <div class="col-md-4">
            <div class="photo-card">
                <div class="photo-header">Employee Photo</div>

                <div class="photo-placeholder ">
                    <img id="imgPreview"
                         src="@Url.Content(!string.IsNullOrEmpty(Model.ImagePath) ? Model.ImagePath : "~/EmployeeImages/no-image.png")"
                         alt="Employee Photo" />
                </div>

                <div class="file-input-group mb-2">
                    <input type="file" name="ImageUpload" id="customFile" onchange="readURL(this);"
                           class="form-control">

                    <button class="btn" type="button" onclick="resetPhoto()" title="Remove Photo">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>

                @if (isEdit)
                {
                    <small class="text-muted text-center d-block">Leave empty to keep current photo</small>
                }

                <input type="hidden" id="deletePhoto" name="deletePhoto" value="false" />
            </div>
        </div>
            @if (isEdit)
            {
                <style>
                    /* Hover Effect for Tiles */
                    .doc-tile {
                        cursor: pointer;
                        transition: all 0.2s ease-in-out;
                        border: 1px solid #e0e0e0;
                        background-color: #fff;
                    }

                    .doc-tile:hover {
                        transform: translateY(-2px); /* Lift up slightly */
                        box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
                        border-color: #0d6efd; /* Blue border on hover */
                        background-color: #f8f9fa;
                    }
                    
                    .text-truncate-2 {
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                </style>

                <div class="photo-card mt-3 mb-2">
                    <div class="photo-header d-flex justify-content-between align-items-center mb-3">
                        <span>Uploaded Documents</span>
                        <a href="@Url.Action("Index", "Document", new { id = Model.EmpId })"
                            class="btn btn-primary"
                            style="font-size: 14px; padding: 2px 8px;">
                            <i class="bi bi-gear-fill"></i> Manage
                        </a>
                    </div>

                    <div style="width: 100%; max-height: 350px; overflow-y: auto; overflow-x: hidden; padding: 2px;">
                        @if (ViewBag.EmployeeDocuments != null)
                        {
                            var docs = ViewBag.EmployeeDocuments as IEnumerable<EmployeeApp.Models.vw_EmployeeDocs>;

                            if (docs.Any())
                            {
                                <div class="row g-2">
                                    @foreach (var doc in docs)
                                    {
                                        <div class="col-3">
                                            <div class="card h-100 w-50 shadow-sm doc-tile text-center p-2"
                                                    onclick="location.href='@Url.Action("Download", "Document", new { filePath = doc.DocPath })'"
                                                    title="Click to Download: @doc.DocName">

                                                <div class="card-body p-1">
                                                    <i class="bi bi-file-earmark-text-fill text-primary" style="font-size: 2.5rem;"></i>

                                                    <h6 class="card-title mt-2 mb-1 text-dark text-truncate-2" style="font-size: 13px; font-weight: bold;">
                                                        @doc.DocName
                                                    </h6>

                                                    <small class="text-muted d-block text-truncate" style="font-size: 11px;">
                                                        @(!string.IsNullOrEmpty(doc.DocDesc) ? doc.DocDesc : "Download")
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center text-muted p-4 border rounded bg-light">
                                    <i class="bi bi-folder-x" style="font-size: 2rem;"></i>
                                    <p class="mb-0 mt-2 small">No documents found.</p>
                                </div>
                            }
                        }
                    </div>
                </div>
            }
        </div>
     }
</div>

<div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Success</h5>
                <button type="button" class="close text-white" data-dismiss="modal" onclick="$('#successModal').modal('hide')">&times;</button>
            </div>
            <div class="modal-body text-center">
                <p class="lead mt-3">@(isEdit ? "Employee updated successfully!" : "Employee registered successfully!")</p>
                <div style="font-size: 50px; color: green;">&#10004;</div>
            </div>
            <div class="modal-footer">
                @Html.ActionLink("Go to List", "Index", null, new { @class = "btn btn-primary" })
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            // 1. Init Datepickers
            $("#txtDOB").datepicker({ dateFormat: "dd-mm-yy", changeMonth: true, changeYear: true });
            $("#txtJoin").datepicker({ dateFormat: "dd-mm-yy", changeMonth: true, changeYear: true });

            // 2. CHECK FOR SERVER MESSAGES

            // A. Error Popup (Aadhaar Duplicate)
            var alertMsg = '@Html.Raw(ViewBag.AlertMessage)';
            if (alertMsg && alertMsg.length > 0) {
                alert(alertMsg);
            }

            // B. Success Modal (Saved Successfully)
            var successMsg = '@Html.Raw(ViewBag.SuccessMessage)';
            if (successMsg && successMsg.length > 0) {
                $('#successModal').modal('show');
            }
        });

        // 3. Image Preview
        function readURL(input) {
        if (input.files && input.files[0]) {
            var output = document.getElementById('imgPreview');
            output.src = URL.createObjectURL(input.files[0]);
            // NEW: If a new file is selected, set delete flag to false
            document.getElementById('deletePhoto').value = "false";
            }
        }

    // NEW: Function to reset the photo
        function resetPhoto() {
            // 1. Clear the file input so no file is submitted
            document.getElementById('customFile').value = "";

            // 2. Reset the image preview to the default image
            document.getElementById('imgPreview').src = "@Url.Content("~/EmployeeImages/no-image.png")";

            // 3. Set the hidden field to "true" to tell the server to delete the photo
            document.getElementById('deletePhoto').value = "true";
        }

        // 4. Validation
        function validateForm() {
            var name = document.getElementById('txtName');
            if (name.value.trim() === '') { alert("Please enter Employee Name"); name.focus(); return false; }
            if (!/^[A-Za-z ]{2,50}$/.test(name.value.trim())) { alert("Please enter a valid Employee Name (Alphabets only)"); name.focus(); return false; }

            var gender = document.querySelector("input[name='Gender']:checked");
            if (!gender) { alert("Please select Gender"); document.getElementById('genderMale').focus(); return false; }

            var dob = document.getElementById('txtDOB');
            if (dob.value === '') { alert("Please enter Date of Birth"); dob.focus(); return false; }

            var father = document.getElementById('txtFather');
            if (father.value.trim() === '') { alert("Please enter Father's Name"); father.focus(); return false; }
            if (!/^[A-Za-z ]{2,50}$/.test(father.value.trim())) { alert("Please enter a valid Father's Name"); father.focus(); return false; }

            var mobile = document.getElementById('txtMobile');
            if (mobile.value.trim() === '') { alert("Please enter a Mobile Number"); mobile.focus(); return false; }
            if (!/^\d{10}$/.test(mobile.value.trim())) { alert("Please enter a valid 10 digit Mobile Number"); mobile.focus(); return false; }

            var email = document.getElementById('txtEmail');
            if (email.value.trim() === '') { alert("Please enter Email ID"); email.focus(); return false; }
            if (!/^[a-zA-Z0-9._%+-]+@@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email.value.trim())) { alert("Please enter a valid Email ID"); email.focus(); return false; }

            var address = document.getElementById('txtAddress');
            if (address.value.trim() === '') { alert("Please enter Address"); address.focus(); return false; }
            if (!/^[a-zA-Z0-9 .,/]{5,36}$/.test(address.value.trim())) { alert("Please enter a valid Address under 35 characters"); address.focus(); return false; }

            var joinDate = document.getElementById('txtJoin');
            if (joinDate.value === '') { alert("Please enter Joining Date"); joinDate.focus(); return false; }

            var dept = document.getElementById('ddlDept');
            if (dept.value === '') { alert("Please select Department"); dept.focus(); return false; }

            var aadhaar = document.getElementById('txtAadhaar');
            if (aadhaar.value.trim() !== '') {
                if (!/^\d{12}$/.test(aadhaar.value.trim())) { alert("Please enter valid 12-digit Aadhaar Number"); aadhaar.focus(); return false; }
            }
            return true;
        }
    </script>
}