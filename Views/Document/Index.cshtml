@model IEnumerable<EmployeeApp.Models.vw_EmployeeDocs>

@{
    ViewBag.Title = "Manage Documents";
    // Get the currently selected ID to pre-fill inputs if needed
    var currentId = ViewBag.CurrentEmpId;
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<div class="container-fluid">
    <div class="row">
        <div class="col-md-4">
            <div class="panel panel-primary">
                <div class="panel-heading text-center mb-2" style="font-weight: bold;">Upload New Document</div>
                <div class="panel-body">

                    @if (TempData["Message"] != null)
                    {<div class="alert alert-success">@TempData["Message"]</div>}
                    @if (TempData["Error"] != null)
                    {<div class="alert alert-danger">@TempData["Error"]</div>}

                    @using (Html.BeginForm("Upload", "Document", FormMethod.Post, new { enctype = "multipart/form-data" }))
                    {
                        <div class="form-group mb-3">
                            <label>Select Employee (Filter & Upload)</label>

                            @Html.DropDownList("EmpId", (SelectList)ViewBag.EmpList, "-- All Employees --", new
                            {
                                @class = "form-control",
                                required = "required",
                                onchange = "window.location.href='" + Url.Action("Index", "Document") + "?id=' + this.value"
                            })
                        </div>

                        <div class="form-group mb-3">
                            <label>Document Name</label>
                            <input type="text" name="DocName" class="form-control" placeholder="e.g. Resume" required />
                        </div>

                        <div class="form-group mb-3">
                            <label>Description</label>
                            <textarea name="DocDesc" class="form-control" rows="3" placeholder="Optional"></textarea>
                        </div>

                        <div class="form-group mb-3">
                            <label>Select File</label>
                            <input type="file" name="fileUpload" class="form-control" required />
                        </div>

                        <button type="submit" class="btn btn-success">Upload Document</button>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="panel panel-default">
                <div class="panel-heading text-center mb-2" style="font-weight: bold;">
                    Uploaded Documents
                    @if (currentId != null)
                    {
                        <span class="label label-info pull-right">Filtered View</span>
                    }
                </div>
                <div class="panel-body">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th style="white-space: nowrap;">Employee</th>
                                <th style="white-space: nowrap;">Doc Name</th>
                                <th style="white-space: nowrap;">Description</th>
                                <th style="white-space: nowrap;">Uploaded On</th>
                                <th style="width: 150px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model != null && Model.Any())
                            {
                                foreach (var item in Model)
                                {
                                    <tr>
                                        <td>@item.EmployeeName</td>
                                        <td>@item.DocName</td>
                                        <td>@item.DocDesc</td>
                                        <td>@item.CreatedOn.Value.ToString("dd-MMM-yyyy")</td>
                                        <td>
                                            <a href="@Url.Action("Download", "Document", new { filePath = item.DocPath })" class="btn btn-primary" title="Download">
                                                <i class="bi bi-download"></i>
                                            </a>

                                            <a href="@Url.Action("Delete", "Document", new { id = item.DocID })"
                                               class="btn btn-danger"
                                               onclick="return confirm('Are you sure you want to permanently delete this document?');"
                                               title="Delete">
                                                <i class="bi bi-trash3-fill"></i>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        @(currentId == null ? "No documents found." : "No documents found for this employee.")
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Check if the alert exists
            var alertBox = $(".alert");
            if (alertBox.length > 0) {
                // Wait 10 seconds (10000ms), then fade it out
                setTimeout(function () {
                    alertBox.fadeOut("slow");
                }, 5000);
            }
        });
    </script>
}
